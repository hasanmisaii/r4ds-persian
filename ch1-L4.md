# 4 گردش کار: سبک کدنویسی 

سبک خوب کدنویسی مانند علائم نگارشیِ درست است: می‌توان بدون آن کار کرد، اماواقعاًآنراآسان‌ترمی‌کندکهبخوانید. حتی به عنوان یک برنامه‌نویس بسیار مبتدی، کار روی سبک کدتان ایده خوبی است. استفاده از یک سبک سازگار باعث می‌شود دیگران (از جمله در آینده شما!) آسان‌تر کارتان را بخوانند و این به خصوص اگر نیاز به کمک از کس دیگری داشته باشید مهم است. این فصل مهم‌ترین نکات [راهنمای سبک tidyverse](https://style.tidyverse.org) را معرفی خواهد کرد که در سراسر این کتاب استفاده می‌شود.

سبک دادن به کدتان در ابتدا کمی خسته‌کننده خواهد بود، اما اگر آن را تمرین کنید، خیلی زود برایتان عادی می‌شود. علاوه بر این، ابزارهای بسیار عالی برای تغییر سبک سریع کد موجود وجود دارد، مانند بسته [**styler**](https://styler.r-lib.org) توسط لورنتز والترت. پس از نصب آن با `install.packages("styler")`، راه آسان برای استفاده از آن از طریق **پالت فرمان** RStudio است. پالت فرمان به شما اجازه استفاده از هر دستور داخلی RStudio و بسیاری از افزونه‌های ارائه‌شده توسط بسته‌ها را می‌دهد. پالت را با فشردن Cmd/Ctrl + Shift + P باز کنید، سپس "styler" را تایپ کنید تا تمام میانبرهای ارائه شده توسط styler را ببینید. [ شکل 1.4 ](#figure-4.1) نتایج را نشان می‌دهد.
  
![Alt text](Images/rstudio-palette.png)
*شکل 1.4: پالت دستورهای RStudio تنها با استفاده از صفحه کلید دسترسی به هر دستور RStudio را آسان می‌کند.*

در این فصل از بسته‌های tidyverse و nycflights13 برای مثال‌های کد استفاده خواهیم کرد.

```{r}
library(tidyverse)
library(nycflights13)
```

## 1.4 نام‌ها

به طور خلاصه در بخش 3.2 در مورد نام‌ها صحبت کردیم. به یاد داشته باشید که نام متغیرها (آنهایی که با عملگر تخصیص `->` یا تابع `()mutate` ایجاد می‌شوند) باید فقط از حروف کوچک، اعداد و `_` استفاده کنند. از `_` برای جدا کردن کلمات در یک نام استفاده کنید.

```{r}
# تلاش کنید برای:
short_flights <- flights |> filter(air_time < 60)

# اجتناب کنید:
SHORTFLIGHTS <- flights |> filter(air_time < 60)
```

به عنوان یک قاعده کلی، بهتر است نام‌های طولانی و توصیفی که به راحتی قابل فهم هستند را به نام‌های مختصر که سریع تایپ می‌شوند ترجیح دهید. نام‌های کوتاه هنگام نوشتن کد، زمان نسبتاً کمی را صرفه‌جویی می‌کنند (به خصوص از آنجا که تکمیل خودکار به شما کمک می‌کند آنها را کامل کنید)، اما زمانی که به کد قدیمی بازمی‌گردید و مجبور به کشف یک مخفف رمزآلود هستید، می‌تواند زمان‌بر باشد.

اگر نام‌های زیادی برای چیزهای مرتبط دارید، تمام تلاش‌تان این باشد تا نام‌هایتان سازگار (یک‌دست) باشند. وقتی یک قاعده قبلی را فراموش می‌کنید، به راحتی ممکن است ناهماهنگی ایجاد شود، پس اگر مجبور به برگشتن و تغییر نام شئ‌ها هستید احساس بدی نداشته باشید. به طور کلی، اگر تعدادی متغیر دارید که انواع مختلفی از یک موضوع هستند، بهتر است به جای پسوند یک پیشوند مشترک به آنها بدهید چون تکمیل خودکار بر روی ابتدای یک متغیر بهتر کار می‌کند.

## 2.4 فاصله‌ها

در دو طرف عملگرهای ریاضی به جز `^` (یعنی `+`، `-`، `==`، `<`، ...) و اطراف عملگر تخصیص (`->`) فاصله قرار دهید.

```{r}
# تلاش کنید برای
z <- (a + b)^2 / d

# اجتناب کنید
z<-( a + b ) ^ 2/d
```

در داخل یا خارج پرانتز برای فراخوانی معمول تابع فاصله قرار ندهید. همیشه بعد از ویرگول درست مانند زبان انگلیسی استاندارد فاصله قرار دهید.

```{r}
# تلاش کنید برای
mean(x, na.rm = TRUE)

# اجتناب کنید
mean (x ,na.rm=TRUE)
```

اگر اضافه کردن فاصله‌های اضافی باعث بهبود ترازبندی می‌شود، ایرادی ندارد. برای مثال، اگر متغیرهای متعددی در `()mutate` ایجاد می‌کنید، ممکن است با اضافه کردن فاصله‌ها بخواهید تا همه `=` در یک خط قرار بگیرند. این کار خواندن کد را آسان‌تر می‌کند.

```{r}
flights |> 
  mutate(
    speed      = distance / air_time,
    dep_hour   = dep_time %/% 100,
    dep_minute = dep_time %%  100
  )
```

## 3.4 پایپ‌ها {#sec-pipes}

`<|` همیشه باید فاصله‌ای قبل از خود داشته باشد و معمولاً باید آخرین مورد در یک خط باشد. این کار اضافه کردن خط‌های جدید، تنظیم مجدد خط‌های موجود، تغییر عناصر درون یک خط و مرور سریع تابع‌های سمت چپ را آسان‌تر می‌کند.
‍
```{r}
# تلاش کنید برای 
flights |>  
  filter(!is.na(arr_delay), !is.na(tailnum)) |> 
  count(dest)

# اجتناب کنید
flights|>filter(!is.na(arr_delay), !is.na(tailnum))|>count(dest)
```

اگر تابعی که به آن پایپ می‌کنید آرگومان‌های نام‌گذاری شده دارد (مانند `()mutate` یا `()summarize`)، هر آرگومان را در خط جدید قرار دهید. اگر تابع آرگومان‌های نام‌گذاری شده ندارد (مانند `()select` یا `()filter`)، همه چیز را در یک خط نگه دارید مگر اینکه جا نشود، در این صورت باید هر آرگومان را در خط جداگانه‌اش قرار دهید.

```{r}
# تلاش کنید برای
flights |>  
  group_by(tailnum) |> 
  summarize(
    delay = mean(arr_delay, na.rm = TRUE),
    n = n()
  )

# اجتناب کنید
flights |>
  group_by(
    tailnum
  ) |> 
  summarize(delay = mean(arr_delay, na.rm = TRUE), n = n())
```

بعد از مرحله اول پایپ، هر خط را به اندازه‌ی دو فاصله تورفتگی دهید. RStudio به طور خودکار فاصله‌ها را پس از شکست خط بعد از `<|` برایتان قرار می‌دهد. اگر هر آرگومان را در خط جداگانه‌اش قرار می‌دهید، دو فاصله اضافی تورفتگی ایجاد کنید. مطمئن شوید `(` در خط جداگانه‌اش است و بدون تورفتگی است تا با موقعیت افقی نام تابع مطابقت داشته باشد.
‍‍
```{r}
# تلاش کنید برای 
flights |>  
  group_by(tailnum) |> 
  summarize(
    delay = mean(arr_delay, na.rm = TRUE),
    n = n()
  )

# اجتناب کنید
flights|>
  group_by(tailnum) |> 
  summarize(
             delay = mean(arr_delay, na.rm = TRUE), 
             n = n()
           )

# اجتناب کنید
flights|>
  group_by(tailnum) |> 
  summarize(
  delay = mean(arr_delay, na.rm = TRUE), 
  n = n()
  )
```

اگر پایپ شما به راحتی در یک خط جا می‌شود، نقض برخی از این قوانین اشکالی ندارد. اما در تجربه جمعی ما، معمول است که قطعات کوتاه طولانی‌تر شوند، پس معمولاً با شروع با تمام فضای عمودی مورد نیاز، در درازمدت در زمان صرفه‌جویی خواهید کرد.

```{r}
# این به طور فشرده در یک خط جا می‌شود
df |> mutate(y = x + 1)

# در حالی که این 4 برابر خط بیشتر می‌گیرد، اما به راحتی میتوان
# آن را به متغیرهای بیشتر و مراحل بیشتر در آینده گسترش داد.
df |> 
  mutate(
    y = x + 1
  )
```

در نهایت، از نوشتن پایپ‌های خیلی طولانی، مثلاً بیش از ۱۰-۱۵ خط، خودداری کنید. سعی کنید آنها را به کارهای فرعی کوچک‌تر تقسیم کنید، به هر کار نام اطلاع‌رسان بدهید. این نام‌ها به خواننده کمک می‌کنند تا از آنچه اتفاق می‌افتد مطلع شود و بررسی اینکه نتایج میانی مطابق انتظار هستند را آسان‌تر می‌کند. هر زمان که می‌توانید به چیزی یک نام اطلاع‌رسان بدهید، باید این کار را انجام دهید، برای مثال زمانی که ساختار داده را اساساً تغییر می‌دهید، مثلاً پس از چرخش یا خلاصه‌سازی. انتظار نداشته باشید که بار اول آن را درست انجام دهید! در صورت وجود کدهای میانی که بتوانند نام‌های خوب بگیرند این به معنای شکستن خطوط پایپ‌های طولانی است.

## 4.4 بسته ggplot2

همان قوانین اساسی که برای پایپ اعمال می‌شود برای ggplot2 نیز اعمال می‌شود؛ فقط با `+` مانند `<|` رفتار کنید.

```{r}
flights |> 
  group_by(month) |> 
  summarize(
    delay = mean(arr_delay, na.rm = TRUE)
  ) |> 
  ggplot(aes(x = month, y = delay)) +
  geom_point() + 
  geom_line()
```

دوباره، اگر نمی‌توانید همه آرگومان‌های یک تابع را در یک خط قرار دهید، هر آرگومان را در خط جداگانه‌اش قرار دهید:

```{r}
flights |> 
  group_by(dest) |> 
  summarize(
    distance = mean(distance),
    speed = mean(distance / air_time, na.rm = TRUE)
  ) |> 
  ggplot(aes(x = distance, y = speed)) +
  geom_smooth(
    method = "loess",
    span = 0.5,
    se = FALSE, 
    color = "white", 
    linewidth = 4
  ) +
  geom_point()
```

مراقب تغییر از `<|` به `+` باشید. کاش این تغییر لازم نبود، اما متأسفانه ggplot2 قبل از کشف پایپ نوشته شده بود.

## 5.4 بخش‌بندی توضیحات

همچنان که اسکریپت‌های شما طولانی‌تر می‌شوند، می‌توانید از **بخش‌بندی** توضیحات برای تقسیم فایل خود به قطعات قابل مدیریت استفاده کنید:
```{r}
# بارگذاری داده --------------------------------------

# رسم داده --------------------------------------
```

برنامه RStudio میانبر صفحه کلید برای ایجاد این سرتیترها فراهم می‌کند (Cmd/Ctrl + Shift + R)، و آنها را در منوی کشویی راهنمای کد در پایین-سمت چپ ویرایشگر همانند  [ شکل 2.4 ](#figure-4.2) نمایش می‌دهد.

![Alt text](Images/rstudio-nav.png)
*شکل 4.2: پس از افزودن بخش‌بندی توضیحات به اسکریپت خود، می‌توانید به راحتی با استفاده از ابزار راهنمای کد در پایین-سمت چپ ویرایشگر اسکریپت، به آنها دسترسی پیدا کنید.*

## 6.4 تمرینات

1. پایپ‌های زیر را با استفاده از دستورالعمل‌های بالا، مجدداً سبک‌دهی (بازنویسی) کنید.
   
    ```{r}
    flights|>filter(dest=="IAH")|>group_by(year,month,day)|>summarize(n=n(),
    delay=mean(arr_delay,na.rm=TRUE))|>filter(n>10)

    flights|>filter(carrier=="UA",dest%in%c("IAH","HOU"),sched_dep_time>
    0900,sched_arr_time<2000)|>group_by(flight)|>summarize(delay=mean(
    arr_delay,na.rm=TRUE),cancelled=sum(is.na(arr_delay)),n=n())|>filter(n>10)
    ```

## 7.4 خلاصه

در این فصل، مهم‌ترین اصول سبک کدنویسی را یاد گرفته‌اید. این اصول ممکن است در ابتدا مانند مجموعه‌ای از قوانین دلخواه به نظر برسند (چون واقعاً همین‌طور هستند!) اما با گذشت زمان، همانطور که کد بیشتری می‌نویسید و کد را با افراد بیشتری به اشتراک می‌گذارید، خواهید دید که سبک سازگار چقدر مهم است. و بسته styler را فراموش نکنید: یک راه عالی برای بهبود سریع کیفیت کد با سبک ضعیف است.

در فصل بعدی، به ابزارهای علم داده برمی‌گردیم و درباره داده‌های مرتب یاد می‌گیریم. داده مرتب روشی سازگار از سازماندهی چارچوب داده‌هایتان است که در سراسر tidyverse استفاده می‌شود. این سازگاری زندگی شما را آسان‌تر می‌کند زیرا وقتی داده‌های مرتب داشته باشید، با بیشتر تابع‌های tidyverse کار می‌کند. البته، زندگی هرگز آسان نیست، و اکثر مجموعه داده‌هایی که در واقعیت با آنها روبه‌رو می‌شوید از قبل مرتب نخواهند بود. پس ما همچنین به شما یاد خواهیم داد که چگونه از بسته tidyr برای مرتب کردن داده‌های نامنظم خود استفاده کنید.
