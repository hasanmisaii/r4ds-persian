# ۶ گردش کار: اسکریپت‌ها و پروژه‌ها

این فصل شما را با دو ابزار ضروری برای سازماندهی کدتان آشنا خواهد کرد: اسکریپت‌ها و پروژه‌ها.

# 1.6 اسکریپت‌ها

تا کنون، از console برای اجرای کد استفاده کرده‌اید. این جای خوبی برای شروع است، اما به زودی متوجه خواهید شد که وقتی نمودارهای ggplot2 پیچیده‌تر و pipeline‌های dplyr طولانی‌تر ایجاد می‌کنید، فضای کار کمی تنگ می‌شود. برای فراهم کردن فضای بیشتر برای کار، از ویرایشگر اسکریپت استفاده کنید. آن را با کلیک روی منوی File، انتخاب New File، سپس R script باز کنید، یا از میانبر صفحه کلید Cmd/Ctrl + Shift + N استفاده کنید. اکنون چهار پنجره مانند شکل 1.6 خواهید دید. ویرایشگر اسکریپت جای عالی برای آزمایش کد شما است. وقتی می‌خواهید چیزی را تغییر دهید، لازم نیست همه چیز را دوباره تایپ کنید، فقط می‌توانید اسکریپت را ویرایش کنید و دوباره اجرا کنید. زمانی که کدی نوشته‌اید که کار می‌کند و آن چیزی که می‌خواهید را انجام می‌دهد، می‌توانید آن را به عنوان یک فایل اسکریپت ذخیره کنید تا بعداً به راحتی به آن بازگردید.

<div align="center">
<img src="images/script.png" width="650" />
</div>
*شکل 1.6: باز کردن ویرایشگر اسکریپت، یک پنجره جدید در بالا سمت چپ IDE اضافه می‌کند.*



### 1.1.6 اجرای کد

ویرایشگر اسکریپت مکان عالی برای ساخت نمودارهای ggplot2 پیچیده یا دنباله‌های طولانی دستکاری‌های dplyr است. کلید استفاده مؤثر از ویرایشگر اسکریپت حفظ کردن یکی از مهم‌ترین میانبرهای صفحه کلید است: Cmd/Ctrl + Enter. این دستور عبارت R فعلی را در کنسول اجرا می‌کند. برای مثال، کد زیر را در نظر بگیرید.

```{r}
library(dplyr)
library(nycflights13)

not_cancelled <- flights |> 
  filter(!is.na(dep_delay)█, !is.na(arr_delay))

not_cancelled |> 
  group_by(year, month, day) |> 
  summarize(mean = mean(dep_delay))
```

اگر مکان‌نما در انتهای تابع فیلتر (█) باشد، فشردن Cmd/Ctrl + Enter دستور کاملی را که `not_cancelled` تولید می‌کند، اجرا خواهد کرد. همچنین مکان‌نما را به دستور بعدی (شروع با `<| not_cancelled`) منتقل می‌کند. این باعث می‌شود که با فشردن مکرر Cmd/Ctrl + Enter به راحتی تمام اسکریپت را قدم به قدم طی کنید.

به جای اجرای کد به صورت عبارت به عبارت، می‌توانید تمام اسکریپت را در یک مرحله با Cmd/Ctrl + Shift + S اجرا کنید. انجام منظم این کار راهی عالی برای اطمینان از ثبت تمام بخش‌های مهم کد در اسکریپت است.

توصیه می‌کنیم همیشه اسکریپت خود را با بسته‌هایی که نیاز دارید شروع کنید. به این ترتیب، اگر کدتان را با دیگران به اشتراک گذاشتید، آنها به راحتی می‌توانند ببینند کدام بسته‌ها را باید نصب کنند. توجه کنید که هرگز نباید `()install.packages` را در اسکریپتی که به اشتراک می‌گذارید قرار دهید. اگر آنها مراقب نباشند، ارائه اسکریپتی که چیزی را در رایانه آنها تغییر می‌دهد، بی‌ملاحظگی است!

هنگام کار روی فصول آینده، به شدت توصیه می‌کنیم در ویرایشگر اسکریپت شروع کنید و میانبرهای صفحه کلید خود را تمرین کنید. با گذشت زمان، ارسال کد به کنسول به این روش آنقدر طبیعی می‌شود که حتی به آن فکر نخواهید کرد.

### 2.1.6 تشخیص‌های RStudio

در Rstudio، ویرایشگر اسکریپت خطاهای نحوی را با خط قرمز مواج و ضربدری در نوار کناری برجسته می‌کند:

<img src="images/rstudio-diagnostic.png" width="160" />


با گذاشتن موس روی ضربدر می‌توانید خطا را ببینید:

<img src="images/rstudio-diagnostic-tip.png" width="250" />


RStudio همچنین درباره مشکلات احتمالی به شما اطلاع می‌دهد:

<img src="images/rstudio-diagnostic-warn.png" width="450" />

### 3.1.6 ذخیره و نام‌گذاری

RStudio
به طور خودکار محتوای ویرایشگر اسکریپت را هنگام خروج ذخیره می‌کند و هنگام باز کردن مجدد، آن را دوباره بارگذاری می‌کند. با این وجود، ایده خوبی است که از Untitled1، Untitled2، Untitled3 و غیره اجتناب کنید و به جای آن اسکریپت‌هایتان را ذخیره کنید و نام‌های اطلاع‌رسان به آنها بدهید.

ممکن است وسوسه‌انگیز باشد که فایل‌هایتان را `code.R` یا `myscript.R` نام‌گذاری کنید، اما قبل از انتخاب نام برای فایلتان باید کمی بیشتر فکر کنید. سه اصل مهم برای نام‌گذاری فایل به شرح زیر است:

1. نام فایل‌ها باید توسط **ماشین** قابل خواندن باشند: از فاصله، علائم و کاراکترهای ویژه اجتناب کنید. برای تمایز فایل‌ها به حساس بودن به بزرگی و کوچکی حروف تکیه نکنید.
2. نام فایل‌ها باید توسط **انسان** قابل خواندن باشند: از نام فایل‌ها برای توصیف آنچه در فایل است استفاده کنید.
3. نام فایل‌ها باید با مرتب‌سازی پیش‌فرض خوب کار کنند: نام فایل‌ها را با اعداد شروع کنید تا مرتب‌سازی حروف الفبایی آنها را به ترتیبی که استفاده می‌شوند قرار دهد.

برای مثال، فرض کنید فایل‌های زیر را در پوشه پروژه دارید.

```         
alternative model.R
code for exploratory analysis.r
finalreport.qmd
FinalReport.qmd
fig 1.png
Figure_02.png
model_first_try.R
run-first.r
temp.txt
```

مشکلات مختلفی در اینجا وجود دارد: سخت است تشخیص دهید کدام فایل را ابتدا اجرا کنید، نام فایل‌ها حاوی فاصله هستند، دو فایل با نام یکسان اما بزرگی\کوچکی متفاوت حروف وجود دارد (`finalreport` در مقابل `FinalReport`)، و بعضی نام‌ها محتوای خود را توصیف نمی‌کنند (`run-first` و `temp`).

راه بهتر نام‌گذاری و سازماندهی همین مجموعه فایل‌ها به شرح زیر است:

```         
01-load-data.R
02-exploratory-analysis.R
03-model-approach-1.R
04-model-approach-2.R
fig-01.png
fig-02.png
report-2022-03-20.qmd
report-2022-04-02.qmd
report-draft-notes.txt
```

شماره‌گذاری اسکریپت‌های کلیدی، ترتیب اجرای آنها را مشخص می‌کند و یک طرح نامگذاری ثابت، مشاهده‌ی تغییرات را آسان‌تر می‌کند. علاوه بر این، شکل‌ها به طور مشابه برچسب‌گذاری شده‌اند، گزارش‌ها با تاریخ‌های موجود در نام فایل‌ها از هم متمایز می‌شوند، و `temp` به `report-draft-notes` تغییر نام داده شده است تا محتوایش را بهتر توصیف کند. اگر فایل‌های زیادی در یک دایرکتوری دارید، توصیه می‌شود سازماندهی را یک گام فراتر برده و انواع مختلف فایل‌ها (اسکریپت‌ها، شکل‌ها و غیره) را در دایرکتوری‌های مختلف قرار دهید.


## 2.6 پروژه‌ها

یک روز، شما باید R را کنار بگذارید، به سراغ کار دیگری بروید و بعداً به تجزیه و تحلیل خود برگردید. یک روز، به طور همزمان روی چندین تحلیل کار خواهید کرد و می‌خواهید آنها را از هم جدا نگه دارید. یک روز، باید داده‌ها را از دنیای بیرون به R بیاورید و نتایج عددی و شکل‌ها را از R به دنیای بیرون بفرستید.

برای مدیریت این موقعیت‌های دنیای واقعی، باید دو تصمیم بگیرید:

1. منبع حقیقت چیست؟ چه چیزی را به عنوان آخرین کار ثبت‌شده خود، ذخیره خواهید کرد؟
2. تحلیل شما کجا قرار دارد؟

### 1.2.6 منبع حقیقت چیست؟

به عنوان یک مبتدی، اشکالی ندارد که به محیط فعلی خود برای شامل شدن تمام اشیایی که در طول تحلیل خود ایجاد کرده‌اید، تکیه کنید. با این حال، برای آسان‌تر کردن کار بر روی پروژه‌های بزرگ‌تر یا همکاری با دیگران، منبع مورد اتکای شما باید اسکریپت‌های R باشد. با اسکریپت‌های R (و فایل‌های داده خود)، می‌توانید محیط را دوباره بسازید. با تنها محیط خود، بازآفرینی اسکریپت‌های R بسیار دشوارتر است: یا باید مقدار زیادی کد را از حافظه دوباره تایپ کنید (که ناگزیر در طول مسیر اشتباه خواهید کرد) یا باید تاریخچه R خود را با دقت کاوش کنید.

برای کمک به حفظ اسکریپت‌های R خود به عنوان منبع مورد اتکا برای تجزیه و تحلیل خود، اکیداً توصیه می‌کنیم که به RStudio دستور دهید فضای کاری شما را بین محیط‌های کاری حفظ نکند.
می‌توانید این کار را یا با اجرای `()usethis::use_blank_slate` یا با تقلید از گزینه‌های نشان داده شده در تصویر انجام دهید. این کار باعث دردسر در کوتاه‌مدت می‌شود، زیرا اکنون وقتی RStudio را دوباره راه‌اندازی می‌کنید، دیگر کدی که دفعه قبل اجرا کرده اید را به خاطر نمی‌سپارد و اشیاء ایجاد‌شده یا مجموعه داده‌هایی که خوانده‌اید برای استفاده در دسترس نخواهند بود. اما این دردسر کوتاه‌مدت، شما را از دردسرهای بلندمدت نجات می‌دهد زیرا شما را مجبور می‌کند تمام رویه‌های مهم را در کد خود ثبت کنید. هیچ چیز بدتر از این نیست که سه ماه بعد متوجه شوید که فقط نتایج یک محاسبه مهم را در محیط خود ذخیره کرده‌اید، نه خود محاسبه را در کد خود.

<div align="center">
<img src="images/clean-slate.png" width="650" />
</div>
*شکل 2.6: این گزینه‌ها را در گزینه‌های RStudio خود کپی کنید تا همیشه محیط RStudio خود را با یک صفحه خالی شروع کنید.*


یک جفت میانبر صفحه کلید عالی وجود دارد که با هم کار می‌کنند تا مطمئن شوید بخش‌های مهم کد خود را در ویرایشگر ثبت کرده‌اید:

1. برای راه‌اندازی مجدد R، کلیدهای Cmd/Ctrl + Shift + 0/F10 را فشار دهید.
2. برای اجرای مجدد اسکریپت فعلی، کلیدهای Cmd/Ctrl + Shift + S را فشار دهید.

ما در مجموع صدها بار در هفته از این الگو استفاده می‌کنیم.

از طرف دیگر، اگر از میانبرهای صفحه کلید استفاده نمی‌کنید، می‌توانید به Session > Restart R بروید و سپس اسکریپت فعلی خود را هایلایت کرده و دوباره اجرا کنید.
> :information_source: **سرور Rstudio**
> 
>  اگر از سرور Rstudio استفاده می‌کنید، محیط کاری R شما به طور پیش‌فرض هرگز مجدداً راه‌اندازی نمی‌شود. وقتی تب سرور RStudio خود را می‌بندید، ممکن است احساس کنید که R را بسته‌اید، اما سرور در واقع آن را در پس‌زمینه اجرا می‌کند. دفعه بعد که برگردید، دقیقاً در همان جایی خواهید بود که رها کرده‌اید. این امر اهمیت منظم راه‌اندازی مجدد R را بیشتر می‌کند تا با یک صفحه تمیز شروع کنید.




### 2.2.6 تحلیل شما کجا قرار دارد؟

زبان R مفهوم قدرتمندی از **دایرکتوری کاری** دارد. این جایی است که R به دنبال فایل‌هایی می‌گردد که شما از آن می‌خواهید بارگذاری کند، و هر فایلی را که از آن بخواهید ذخیره کند، در آنجا قرار می‌دهد. RStudio دایرکتوری کاری فعلی شما را در بالای کنسول نشان می‌دهد:


<img src="images/rstudio-wd.png" width="300" />

و می‌توانید این را در کد R با اجرای `()getwd` چاپ کنید:

```{r}
getwd()
#> [1] "/Users/hadley/Documents/r4ds"
```

در این محیط کاری R، دایرکتوری کاری فعلی (آن را "خانه" در نظر بگیرید) در پوشه مستندات هادلی، در زیرپوشه‌ای به نام r4ds است. این کد هنگام اجرا نتیجه متفاوتی را برمی‌گرداند، زیرا رایانه شما ساختار دایرکتوری متفاوتی نسبت به کامپیوتر هادلی دارد!

به عنوان کاربر مبتدی R، مشکلی ندارد که بگذارید دایرکتوری کاری شما دایرکتوری خانه، دایرکتوری مستندات، یا هر دایرکتوری عجیب دیگری روی رایانه‌تان باشد. اما شما بیش از چند فصل در این کتاب پیش رفته‌اید، و دیگر مبتدی نیستید. خیلی زود حالا باید به سمت سازماندهی پروژه‌هایتان در دایرکتوری‌ها عادت کنید و هنگام کار روی یک پروژه، دایرکتوری کاری R را روی دایرکتوری مرتبط تنظیم کنید.

می‌توانید دایرکتوری کاری را از درون R تنظیم کنید اما **ما توصیه نمی‌کنیم**:

```{r}
setwd("/path/to/my/CoolProject")
```

راه بهتری وجود دارد؛ راهی که شما را در مسیر مدیریت کار R‌ خود، مانند یک متخصص قرار می‌دهد. آن راه **پروژه RStudio** است.

### 3.2.6 پروژه‌های RStudio

نگه داشتن همه فایل‌های مرتبط با یک پروژه مشخص (داده‌های ورودی، اسکریپت‌های R، نتایج تحلیلی، و شکل‌ها) با هم در یک دایرکتوری رویه‌ای آنقدر عاقلانه و رایج است که RStudio پشتیبانی داخلی برای این کار از طریق **پروژه‌ها** دارد. بیایید پروژه‌ای برای شما بسازیم تا در حین کار بر روی بقیه این کتاب از آن استفاده کنید. روی File > New Project کلیک کنید، سپس مراحل نشان داده شده در شکل 3.6 را دنبال کنید.

<img src="images/new-project.png" width="900" />
*شکل 3.6: برای ایجاد پروژه جدید: (بالا) ابتدا روی New Directory کلیک کنید، سپس (وسط) روی New Project کلیک کنید، سپس (پایین) نام دایرکتوری (پروژه) را وارد کنید، یک زیرشاخه مناسب برای خانه آن انتخاب کنید و روی Create Project کلیک کنید.*

پروژه‌تان را `r4ds` بنامید و به دقت در نظر بگیرید که پروژه را در کدام زیردایرکتوری قرار می‌دهید. اگر آن را در جای معقولی ذخیره نکنید، در آینده پیدا کردنش سخت خواهد بود!

پس از تکمیل این فرآیند، پروژه RStudio جدیدی فقط برای این کتاب خواهید داشت. بررسی کنید که "خانه" پروژه شما، دایرکتوری کاری فعلی باشد:

```{r}
getwd()
#> [1] /Users/hadley/Documents/r4ds
```

حالا دستورات زیر را در ویرایشگر اسکریپت وارد کنید، و فایل را ذخیره کنید و آن را "diamonds.R" بنامید. سپس، پوشه جدیدی به نام "data" ایجاد کنید. می‌توانید این کار را با کلیک روی دکمه "New Folder" در پنل Files در RStudio انجام دهید. در نهایت، اسکریپت کامل را اجرا کنید که یک فایل PNG و CSV در دایرکتوری پروژه‌تان ذخیره خواهد کرد. نگران جزئیات نباشید، بعداً در کتاب آنها را یاد خواهید گرفت.

```{r}
library(tidyverse)

ggplot(diamonds, aes(x = carat, y = price)) + 
  geom_hex()
ggsave("diamonds.png")

write_csv(diamonds, "data/diamonds.csv")
```

از Rstudio خارج شوید. پوشه مرتبط با پروژه خود را بررسی کنید — فایل `Rproj.` را مشاهده کنید. روی آن فایل دابل کلیک کنید تا پروژه دوباره باز شود. توجه داشته باشید به جایی که کار را متوقف کرده بودید، برمی‌گردید: همان دایرکتوری کاری و تاریخچه دستورات است و تمام فایل‌هایی که روی آنها کار می‌کردید هنوز باز هستند. چون دستورات بالایی ما را دنبال کرده‌اید، شما با این حال محیط کاملاً تازه‌ای خواهید داشت که تضمین می‌کند با یک صفحه تمیز شروع می‌کنید.

به روش مورد علاقه‌ی مختص سیستم عامل خود، در رایانه‌تان عبارت `diamonds.png` را جستجو کنید و PNG را پیدا خواهید کرد (تعجب‌آور نیست) اما *همچنین اسکریپتی که آن را ایجاد کرده است* (`diamonds.R`). این برد بزرگی است! یک روز، می‌خواهید شکلی را دوباره بسازید یا فقط بفهمید از کجا آمده است. اگر شکل‌ها را با دقت در فایل‌هایی با کد R ذخیره کنید و هرگز از ماوس یا کلیپ‌بورد استفاده نکنید، می‌توانید کارهای قدیمی را به راحتی بازتولید کنید!


### 4.2.6 مسیرهای نسبی و مطلق

وقتی داخل یک پروژه هستید، فقط باید از مسیرهای نسبی استفاده کنید نه مسیرهای مطلق. تفاوت چیست؟ یک مسیر نسبی نسبت به دایرکتوری کاری، یعنی خانه پروژه، است. وقتی هادلی در بالا `data/diamonds.csv` را نوشت، میانبری برای `/Users/hadley/Documents/r4ds/data/diamonds.csv` بود. اما نکته مهم این است که اگر Mine این کد را روی رایانه‌اش اجرا کند، به `/Users/Mine/Documents/r4ds/data/diamonds.csv` اشاره می‌کند. به همین دلیل مسیرهای نسبی مهم هستند: بدون توجه به اینکه پوشه پروژه R کجا قرار بگیرد، کار خواهند کرد.

مسیرهای مطلق بدون توجه به دایرکتوری کاری شما به همان مکان اشاره می‌کنند. بسته به سیستم‌عامل شما، ظاهر آنها کمی متفاوت است. در Windows آنها با یک حرف درایو (مثل `:C`) یا دو بک‌اسلش (مثل `servername\\`) شروع می‌شوند و در مک\لینوکس با یک اسلش "/" شروع می‌شوند (مثل `users/hadley/`). هرگز **نباید** از مسیرهای مطلق در اسکریپت‌های خود استفاده کنید، چون مانع اشتراک‌گذاری می‌شوند: هیچ کس دیگری دقیقاً همان پیکربندی دایرکتوری شما را نخواهد داشت.



تفاوت مهم دیگری بین سیستم‌عامل‌ها وجود دارد: چگونه اجزای مسیر را جدا می‌کنید. مک و لینوکس از اسلش استفاده می‌کنند (مثل `data/diamonds.csv`) و Windows از بک‌اسلش (مثل `data\diamonds.csv`). R می‌تواند با هر دو نوع کار کند (بدون توجه به اینکه در حال حاضر از کدام پلتفرم استفاده می‌کنید)، اما متأسفانه، بک‌اسلش‌ها برای R معنی خاصی دارند، و برای گرفتن یک بک‌اسلش در مسیر، باید دو بک‌اسلش تایپ کنید! این کار خسته‌کننده است، پس توصیه می‌کنیم همیشه از سبک لینوکس\مک با اسلش‌های رو به جلو استفاده کنید.

## 3.6 تمرین‌ها

 1. به اکانت توییتر [https://twitter.com/rstudiotips](https://twitter.com/rstudiotips) بروید و یک نکته که جالب به نظر می‌رسد پیدا کنید. استفاده از آن را تمرین کنید!
 2. تشخیص‌های Rstudio چه اشتباهات رایج دیگری گزارش می‌کند؟ برای اطلاع از این موارد، به آدرس [https://support.posit.co/hc/en-us/articles/205753617-Code-Diagnostics](https://support.posit.co/hc/en-us/articles/205753617-Code-Diagnostics) مراجعه کنید.

## 4.6 خلاصه

در این فصل، یاد گرفتید که چگونه کد R خود را در اسکریپت‌ها (فایل‌ها) و پروژه‌ها (دایرکتوری‌ها) سازماندهی کنید. درست مثل سبک کد، این کار ممکن است در ابتدا شلوغ به نظر برسد.
اما با جمع‌آوری کدهای بیشتر در چندین پروژه، یاد خواهید گرفت که چگونه یک سازماندهی اولیه از قبل می‌تواند مقدار زیادی زمان در ادامه راه صرفه‌جویی کند.

به طور خلاصه، اسکریپت‌ها و پروژه‌ها یک گردش کار قوی به شما می‌دهند که در آینده به خوبی به شما خدمت خواهد کرد:

- یک پروژه RStudio برای هر پروژه تحلیل داده ایجاد کنید.
- اسکریپت‌هایتان را (با نام‌های اطلاع‌رسان) در پروژه ذخیره کنید، آنها را ویرایش کنید، به صورت تکه‌تکه یا کامل اجرا کنید. مکرراً R را دوباره راه‌اندازی کنید تا مطمئن شوید که همه چیز را در اسکریپت‌های خود ثبت کرده‌اید.
- فقط از مسیرهای نسبی استفاده کنید، نه مسیرهای مطلق.

سپس همه چیزی که نیاز دارید در یک مکان است و به روشنی از همه پروژه‌های دیگری که روی آنها کار می‌کنید جدا شده است.

تاکنون، ما با مجموعه داده‌های موجود در بسته‌های R کار کرده‌ایم. این کار تمرین روی داده‌های از پیش آماده‌شده را آسان‌تر می‌کند، اما بدیهی است که داده‌های شما به این شکل در دسترس نخواهند بود. پس در فصل بعدی، یاد خواهید گرفت که چگونه داده‌ها را از دیسک به محیط کاری R‌ خود با استفاده از بسته readr بارگذاری کنید.
