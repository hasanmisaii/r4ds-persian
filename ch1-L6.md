# ۶ گردش کار: اسکریپت‌ها و پروژه‌ها

این فصل شما را با دو ابزار ضروری برای سازماندهی کدتان آشنا خواهد کرد: اسکریپت‌ها و پروژه‌ها.

## اسکریپت‌ها

تا کنون، از console برای اجرای کد استفاده کرده‌اید.
این جای خوبی برای شروع است، اما به زودی متوجه خواهید شد که وقتی نمودارهای ggplot2 پیچیده‌تر و pipeline‌های dplyr طولانی‌تر ایجاد می‌کنید، فضای کار تنگ می‌شود.
برای فراهم کردن فضای بیشتر برای کار، از script editor استفاده کنید.
آن را با کلیک روی منوی File، انتخاب New File، سپس R script باز کنید، یا از میانبر کیبورد Cmd/Ctrl + Shift + N استفاده کنید.
حالا چهار پنل را خواهید دید، همانطور که در تصویر نشان داده شده است.
Script editor جای عالی برای آزمایش با کدتان است.
وقتی می‌خواهید چیزی را تغییر دهید، لازم نیست همه چیز را دوباره تایپ کنید، فقط می‌توانید اسکریپت را ویرایش کنید و دوباره اجرا کنید.
و زمانی که کدی نوشته‌اید که کار می‌کند و آن چیزی که می‌خواهید را انجام می‌دهد، می‌توانید آن را به عنوان یک فایل اسکریپت ذخیره کنید تا بعداً به راحتی به آن بازگردید.

### اجرای کد

Script editor مکان عالی برای ساخت نمودارهای ggplot2 پیچیده یا دنباله‌های طولانی دستکاری‌های dplyr است.
کلید استفاده مؤثر از script editor حفظ کردن یکی از مهم‌ترین میانبرهای کیبورد است: Cmd/Ctrl + Enter.
این دستور عبارت R فعلی را در console اجرا می‌کند.
برای مثال، کد زیر را در نظر بگیرید.

```{r}
#| eval: false
library(dplyr)
library(nycflights13)

not_cancelled <- flights |> 
  filter(!is.na(dep_delay), !is.na(arr_delay))

not_cancelled |> 
  group_by(year, month, day) |> 
  summarize(mean = mean(dep_delay))
```

اگر مکان‌نما (cursor) در انتهای خط فیلتر باشد، فشردن Cmd/Ctrl + Enter دستور کامل تولید کننده `not_cancelled` را اجرا خواهد کرد.
همچنین مکان‌نما را به دستور بعدی (شروع با `not_cancelled |>`) منتقل می‌کند.
این باعث می‌شود که با فشردن مکرر Cmd/Ctrl + Enter به راحتی تمام اسکریپت را قدم به قدم طی کنید.

به جای اجرای کد عبارت به عبارت، می‌توانید تمام اسکریپت را در یک مرحله با Cmd/Ctrl + Shift + S اجرا کنید.
انجام منظم این کار راه عالی برای اطمینان از اینکه همه بخش‌های مهم کدتان را در اسکریپت ضبط کرده‌اید است.

توصیه می‌کنیم همیشه اسکریپت خود را با بسته‌هایی که نیاز دارید شروع کنید.
به این ترتیب، اگر کدتان را با دیگران به اشتراک گذاشتید، آنها به راحتی می‌توانند ببینند کدام بسته‌ها را باید نصب کنند.
توجه کنید که هرگز نباید `install.packages()` را در اسکریپتی که به اشتراک می‌گذارید قرار دهید.
تحویل دادن اسکریپتی که اگر دقت نکنند چیزی در رایانه‌شان تغییر می‌دهد، بی‌ادبی است!

هنگام کار روی فصول آینده، به شدت توصیه می‌کنیم در script editor شروع کنید و میانبرهای کیبوردتان را تمرین کنید.
با گذشت زمان، ارسال کد به console به این روش آنقدر طبیعی می‌شود که حتی به آن فکر نخواهید کرد.

### تشخیص‌های RStudio

در script editor، RStudio خطاهای نحوی را با خط قرمز مواج و ضربدری در نوار کناری برجسته می‌کند:

با گذاشتن موس روی ضربدر می‌توانید مشکل را ببینید:

RStudio همچنین درباره مشکلات احتمالی به شما اطلاع می‌دهد:

### ذخیره و نام‌گذاری

RStudio به طور خودکار محتوای script editor را هنگام خروج ذخیره می‌کند و هنگام بازگشایی مجدد به طور خودکار بازیابی می‌کند.
با این وجود، ایده خوبی است که از Untitled1، Untitled2، Untitled3 و غیره اجتناب کنید و به جای آن اسکریپت‌هایتان را ذخیره کنید و نام‌های اطلاع‌رسان به آنها بدهید.

ممکن است وسوسه‌انگیز باشد که فایل‌هایتان را `code.R` یا `myscript.R` نام بگذارید، اما قبل از انتخاب نام برای فایلتان باید کمی بیشتر فکر کنید.
سه اصل مهم برای نام‌گذاری فایل به شرح زیر است:

1. نام فایل‌ها باید **توسط ماشین** قابل خواندن باشند: از فاصله، علائم و کاراکترهای ویژه اجتناب کنید. برای تمایز فایل‌ها به حساس بودن به بزرگی و کوچکی حروف تکیه نکنید.
2. نام فایل‌ها باید **توسط انسان** قابل خواندن باشند: از نام فایل‌ها برای توصیف آنچه در فایل است استفاده کنید.
3. نام فایل‌ها باید با مرتب‌سازی پیش‌فرض خوب کار کنند: نام فایل‌ها را با اعداد شروع کنید تا مرتب‌سازی حروف الفبایی آنها را به ترتیبی که استفاده می‌شوند قرار دهد.

برای مثال، فرض کنید فایل‌های زیر را در پوشه پروژه دارید.

```         
alternative model.R
code for exploratory analysis.r
finalreport.qmd
FinalReport.qmd
fig 1.png
Figure_02.png
model_first_try.R
run-first.r
temp.txt
```

مشکلات مختلفی در اینجا وجود دارد: سخت است تشخیص دهید کدام فایل را ابتدا اجرا کنید، نام فایل‌ها حاوی فاصله هستند، دو فایل با همان نام اما بزرگی/کوچکی متفاوت حروف وجود دارد (`finalreport` در مقابل `FinalReport`)، و بعضی نام‌ها محتوای خود را توصیف نمی‌کنند (`run-first` و `temp`).

راه بهتر نام‌گذاری و سازماندهی همین مجموعه فایل‌ها به شرح زیر است:

```         
01-load-data.R
02-exploratory-analysis.R
03-model-approach-1.R
04-model-approach-2.R
fig-01.png
fig-02.png
report-2022-03-20.qmd
report-2022-04-02.qmd
report-draft-notes.txt
```

شماره‌گذاری اسکریپت‌های کلیدی واضح می‌کند که به چه ترتیبی باید اجرا شوند و طرح نام‌گذاری سازگار تشخیص آنچه متفاوت است را آسان‌تر می‌کند.
علاوه بر این، شکل‌ها مشابه برچسب‌گذاری شده‌اند، گزارش‌ها با تاریخ‌های موجود در نام فایل‌ها متمایز می‌شوند، و `temp` به `report-draft-notes` تغییر نام داده شده تا محتوایش را بهتر توصیف کند.
اگر فایل‌های زیادی در یک دایرکتوری دارید، یک قدم جلوتر رفتن در سازماندهی و قرار دادن انواع مختلف فایل‌ها (اسکریپت‌ها، شکل‌ها و غیره) در دایرکتوری‌های مختلف توصیه می‌شود.

## پروژه‌ها

یک روز، باید R را ترک کنید، کار دیگری انجام دهید، و بعداً به تحلیلتان بازگردید.
یک روز، روی چندین تحلیل همزمان کار خواهید کرد و می‌خواهید آنها را جدا نگه دارید.
یک روز، باید داده‌ها را از دنیای بیرون به R بیاورید و نتایج عددی و شکل‌ها را از R به دنیای بیرون بفرستید.

برای مدیریت این موقعیت‌های دنیای واقعی، باید دو تصمیم بگیرید:

1. منبع حقیقت چیست؟
   چه چیزی را به عنوان سابقه دائمی از آنچه اتفاق افتاده ذخیره خواهید کرد؟

2. تحلیل شما کجا زندگی می‌کند؟

### منبع حقیقت چیست؟

به عنوان یک مبتدی، تکیه کردن روی Environment فعلی‌تان برای شامل بودن همه اشیائی که در طول تحلیل ایجاد کرده‌اید مشکلی ندارد.
با این حال، برای آسان‌تر کردن کار روی پروژه‌های بزرگ‌تر یا همکاری با دیگران، منبع حقیقت شما باید اسکریپت‌های R باشد.
با اسکریپت‌های R (و فایل‌های داده‌تان)، می‌توانید محیط را دوباره بسازید.
تنها با محیط‌تان، بازسازی اسکریپت‌های R بسیار دشوارتر است: یا باید کد زیادی را از حافظه دوباره تایپ کنید (که اجتناب‌ناپذیر در طول راه اشتباه خواهید کرد) یا باید به دقت تاریخ R‌تان را استخراج کنید.

برای کمک به حفظ اسکریپت‌های R شما به عنوان منبع حقیقت برای تحلیلتان، به شدت توصیه می‌کنیم که به RStudio دستور دهید workspace را بین جلسات حفظ نکند.
می‌توانید این کار را یا با اجرای `usethis::use_blank_slate()` یا با تقلید از گزینه‌های نشان داده شده در تصویر انجام دهید. این کار باعث درد کوتاه‌مدت می‌شود، چون حالا وقتی RStudio را دوباره راه‌اندازی می‌کنید، دیگر کدی که دفعه قبل اجرا کردید را به خاطر نمی‌آورد و نه اشیائی که ایجاد کردید یا مجموعه داده‌هایی که خواندید برای استفاده در دسترس خواهند بود.
اما این درد کوتاه‌مدت شما را از عذاب طولانی‌مدت نجات می‌دهد چون مجبورتان می‌کند همه روش‌های مهم را در کدتان ضبط کنید.
چیزی بدتر از کشف سه ماه بعد از اینکه تنها نتایج یک محاسبه مهم را در محیط‌تان ذخیره کرده‌اید، نه خود محاسبه را در کدتان، وجود ندارد.

جفت میانبر کیبوردی عالی وجود دارد که با هم کار خواهند کرد تا مطمئن شوید بخش‌های مهم کدتان را در editor ضبط کرده‌اید:

1. Cmd/Ctrl + Shift + 0/F10 را فشار دهید تا R را دوباره راه‌اندازی کنید.
2. Cmd/Ctrl + Shift + S را فشار دهید تا اسکریپت فعلی را دوباره اجرا کنید.

ما در مجموع صدها بار در هفته از این الگو استفاده می‌کنیم.

به طور جایگزین، اگر از میانبرهای کیبورد استفاده نمی‌کنید، می‌توانید به Session > Restart R بروید و سپس اسکریپت فعلی‌تان را برجسته کنید و دوباره اجرا کنید.

::: callout-note
## سرور RStudio

اگر از سرور RStudio استفاده می‌کنید، جلسه R شما هرگز به طور پیش‌فرض دوباره راه‌اندازی نمی‌شود.
وقتی تب سرور RStudio را می‌بندید، ممکن است احساس کنید R را می‌بندید، اما سرور در واقع آن را در پس‌زمینه اجرا نگه می‌دارد.
دفعه بعد که برمی‌گردید، دقیقاً در همان جایی خواهید بود که رها کردید.
این امر اهمیت منظم راه‌اندازی مجدد R را بیشتر می‌کند تا با یک صفحه تمیز شروع کنید.
:::

### تحلیل شما کجا زندگی می‌کند؟

R مفهوم قدرتمندی از **دایرکتوری کاری** دارد.
اینجا جایی است که R برای فایل‌هایی که از آن می‌خواهید بارگیری کند جستجو می‌کند، و جایی است که هر فایلی را که از آن می‌خواهید ذخیره کند قرار می‌دهد.
RStudio دایرکتوری کاری فعلی شما را در بالای console نشان می‌دهد:

و می‌توانید این را در کد R با اجرای `getwd()` چاپ کنید:

```{r}
#| eval: false
getwd()
#> [1] "/Users/hadley/Documents/r4ds"
```

در این جلسه R، دایرکتوری کاری فعلی (آن را "خانه" در نظر بگیرید) در پوشه Documents هادلی، در زیرپوشه‌ای به نام r4ds است.
این کد وقتی اجرایش می‌کنید نتیجه متفاوتی برمی‌گرداند، چون رایانه شما ساختار دایرکتوری متفاوتی از هادلی دارد!

به عنوان کاربر مبتدی R، مشکلی ندارد که بگذارید دایرکتوری کاری شما دایرکتوری خانه، دایرکتوری اسناد، یا هر دایرکتوری عجیب دیگری روی رایانه‌تان باشد.
اما شما بیش از چند فصل در این کتاب پیش رفته‌اید، و دیگر مبتدی نیستید.
خیلی زود حالا باید به سمت سازماندهی پروژه‌هایتان در دایرکتوری‌ها تکامل یابید و هنگام کار روی یک پروژه، دایرکتوری کاری R را روی دایرکتوری مرتبط تنظیم کنید.

می‌توانید دایرکتوری کاری را از درون R تنظیم کنید اما **ما توصیه نمی‌کنیم**:

```{r}
#| eval: false
setwd("/path/to/my/CoolProject")
```

راه بهتری وجود دارد؛ راهی که همچنین شما را در مسیر مدیریت کار R‌تان مانند یک متخصص قرار می‌دهد.
آن راه **پروژه RStudio** است.

### پروژه‌های RStudio

نگه داشتن همه فایل‌های مرتبط با یک پروژه مشخص (داده‌های ورودی، اسکریپت‌های R، نتایج تحلیلی، و شکل‌ها) با هم در یک دایرکتوری رویه‌ای آنقدر عاقلانه و رایج است که RStudio پشتیبانی داخلی برای این کار از طریق **پروژه‌ها** دارد.
بیایید پروژه‌ای برای شما بسازیم تا در حین کار روی بقیه این کتاب استفاده کنید.
روی File > New Project کلیک کنید، سپس مراحل نشان داده شده در تصویر را دنبال کنید.

پروژه‌تان را `r4ds` بنامید و به دقت در نظر بگیرید که پروژه را در کدام زیردایرکتوری قرار می‌دهید.
اگر آن را جای معقولی ذخیره نکنید، در آینده پیدا کردنش سخت خواهد بود!

پس از تکمیل این فرآیند، پروژه RStudio جدیدی فقط برای این کتاب خواهید داشت.
بررسی کنید که "خانه" پروژه‌تان دایرکتوری کاری فعلی است:

```{r}
#| eval: false
getwd()
#> [1] /Users/hadley/Documents/r4ds
```

حالا دستورات زیر را در script editor وارد کنید، و فایل را ذخیره کنید و آن را "diamonds.R" بنامید.
سپس، پوشه جدیدی به نام "data" ایجاد کنید.
می‌توانید این کار را با کلیک روی دکمه "New Folder" در پنل Files در RStudio انجام دهید.
در نهایت، اسکریپت کامل را اجرا کنید که یک فایل PNG و CSV در دایرکتوری پروژه‌تان ذخیره خواهد کرد.
نگران جزئیات نباشید، بعداً در کتاب آنها را یاد خواهید گرفت.

```{r}
#| label: toy-line
#| eval: false
library(tidyverse)

ggplot(diamonds, aes(x = carat, y = price)) + 
  geom_hex()
ggsave("diamonds.png")

write_csv(diamonds, "data/diamonds.csv")
```

RStudio را ترک کنید.
پوشه مرتبط با پروژه‌تان را بررسی کنید --- فایل `.Rproj` را مشاهده کنید.
روی آن فایل دابل کلیک کنید تا پروژه دوباره باز شود.
متوجه شوید که به جایی که رها کردید برمی‌گردید: همان دایرکتوری کاری و تاریخ دستورات، و همه فایل‌هایی که روی آنها کار می‌کردید هنوز باز هستند.
چون دستورات بالایی ما را دنبال کردید، با این حال، محیط کاملاً تازه‌ای خواهید داشت که تضمین می‌کند با یک صفحه تمیز شروع می‌کنید.

به روش مورد علاقه‌تان مخصوص سیستم‌عامل، رایانه‌تان را برای `diamonds.png` جستجو کنید و PNG را پیدا خواهید کرد (تعجب‌آور نیست) اما *همچنین اسکریپتی که آن را ایجاد کرده* (`diamonds.R`).
این برد بزرگی است!
یک روز، می‌خواهید شکلی را دوباره بسازید یا فقط بفهمید از کجا آمده.
اگر سختگیرانه شکل‌ها را **با کد R** در فایل‌ها ذخیره کنید و هرگز با موس یا clipboard، قادر خواهید بود کار قدیمی را با سهولت تکثیر کنید!

### مسیرهای نسبی و مطلق

یک بار که داخل پروژه هستید، باید همیشه تنها از مسیرهای نسبی استفاده کنید نه مسیرهای مطلق.
تفاوت چیست؟
مسیر نسبی نسبت به دایرکتوری کاری، یعنی خانه پروژه، است.
وقتی هادلی در بالا `data/diamonds.csv` نوشت، میانبری برای `/Users/hadley/Documents/r4ds/data/diamonds.csv` بود.
اما مهم این است که اگر Mine این کد را روی رایانه‌اش اجرا کند، به `/Users/Mine/Documents/r4ds/data/diamonds.csv` اشاره می‌کند.
به همین دلیل مسیرهای نسبی مهم هستند: بدون توجه به اینکه پوشه پروژه R کجا قرار بگیرد کار خواهند کرد.

مسیرهای مطلق بدون توجه به دایرکتوری کاری شما به همان مکان اشاره می‌کنند.
بسته به سیستم‌عاملتان کمی متفاوت به نظر می‌رسند.
در Windows با حرف درایو شروع می‌شوند (مثل `C:`) یا دو بک‌اسلش (مثل `\\servername`) و در Mac/Linux با اسلش "/" شروع می‌شوند (مثل `/users/hadley`).
هرگز **نباید** از مسیرهای مطلق در اسکریپت‌هایتان استفاده کنید، چون مانع اشتراک‌گذاری می‌شوند: هیچ کس دیگری دقیقاً همان پیکربندی دایرکتوری شما را نخواهد داشت.

تفاوت مهم دیگری بین سیستم‌عامل‌ها وجود دارد: چگونه اجزای مسیر را جدا می‌کنید.
Mac و Linux از اسلش استفاده می‌کنند (مثل `data/diamonds.csv`) و Windows از بک‌اسلش (مثل `data\diamonds.csv`).
R می‌تواند با هر دو نوع کار کند (بدون توجه به اینکه در حال حاضر از کدام پلتفرم استفاده می‌کنید)، اما متأسفانه، بک‌اسلش‌ها برای R معنی خاصی دارند، و برای گرفتن یک بک‌اسلش در مسیر، باید دو بک‌اسلش تایپ کنید!
این زندگی را ناامیدکننده می‌کند، پس توصیه می‌کنیم همیشه از سبک Linux/Mac با اسلش‌های جلوبه استفاده کنید.

## تمرینها

1. به اکانت توییتر RStudio Tips، <https://twitter.com/rstudiotips> بروید و یک نکته که جالب به نظر می‌رسد پیدا کنید.
   استفاده از آن را تمرین کنید!

2. RStudio diagnostics چه اشتباهات رایج دیگری گزارش می‌کند؟
   <https://support.posit.co/hc/en-us/articles/205753617-Code-Diagnostics> را بخوانید تا متوجه شوید.

## خلاصه

در این فصل، یاد گرفتید که کد R خود را در اسکریپت‌ها (فایل‌ها) و پروژه‌ها (دایرکتوری‌ها) سازماندهی کنید.
درست مثل سبک کد، این کار ممکن است ابتدا مثل کار بیهوده به نظر برسد.
اما همانطور که کد بیشتری در چندین پروژه جمع می‌کنید، یاد خواهید گرفت که چگونه کمی سازماندهی از قبل می‌تواند مقدار زیادی زمان در ادامه راه صرفه‌جویی کند.

به طور خلاصه، اسکریپت‌ها و پروژه‌ها گردش کار محکمی به شما می‌دهند که در آینده به شما خدمت خواهد کرد:

- یک پروژه RStudio برای هر پروژه تحلیل داده ایجاد کنید.
- اسکریپت‌هایتان را (با نام‌های اطلاع‌رسان) در پروژه ذخیره کنید، آنها را ویرایش کنید، به صورت تکه‌ای یا کامل اجرا کنید. مکرراً R را دوباره راه‌اندازی کنید تا مطمئن شوید همه چیز را در اسکریپت‌هایتان ضبط کرده‌اید.
- همیشه تنها از مسیرهای نسبی استفاده کنید، نه مسیرهای مطلق.

سپس همه چیزی که نیاز دارید در یک مکان است و به طور تمیز از همه پروژه‌های دیگری که روی آنها کار می‌کنید جدا شده است.

تا کنون، با مجموعه داده‌هایی که در داخل بسته‌های R بسته‌بندی شده‌اند کار کرده‌ایم.
این کار تمرین روی داده‌های از قبل آماده شده را آسان‌تر می‌کند، اما واضح است که داده‌های شما به این شکل در دسترس نخواهند بود.
پس در فصل بعدی، یاد خواهید گرفت که چگونه داده‌ها را از دیسک به جلسه R‌تان با استفاده از بسته readr بارگیری کنید.